<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Tickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --azul-primario: #1a237e;
      --azul-secundario: #3949ab;
      --gris-fondo: #f5f6fa;
      --gris-card: #fff;
      --gris-borde: #e0e0e0;
      --gris-titulo: #222f3e;
      --gris-texto: #576574;
      --azul-boton: #1976d2;
      --azul-boton-hover: #1565c0;
      --verde: #43a047;
      --rojo: #e53935;
      --amarillo: #fbc02d;
    }
    body {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      background: var(--gris-fondo);
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      color: var(--azul-primario);
      margin-top: 2rem;
      margin-bottom: 1.5rem;
      font-size: 2.2rem;
      letter-spacing: 1px;
    }
    h2 {
      color: var(--gris-titulo);
      margin-top: 2rem;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem 3rem 1rem;
    }
    .filtros {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      background: var(--gris-card);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(26,35,126,0.06);
      padding: 1.2rem 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--gris-borde);
    }
    .filtros label {
      font-weight: 500;
      color: var(--gris-titulo);
      margin-right: 0.5rem;
    }
    .filtros input, .filtros select {
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
      border: 1px solid var(--gris-borde);
      font-size: 1rem;
      background: #f8fafc;
      color: var(--gris-texto);
      margin-right: 1rem;
    }
    .filtros button {
      background: var(--azul-boton);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-left: 0.5rem;
    }
    .filtros button:hover {
      background: var(--azul-boton-hover);
    }
    .card {
      background: var(--gris-card);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(26,35,126,0.08);
      padding: 1.5rem 1.2rem 2rem 1.2rem;
      margin-bottom: 2rem;
      border: 1px solid var(--gris-borde);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(26,35,126,0.04);
      margin-bottom: 1.5rem;
    }
    th, td {
      border: 1px solid var(--gris-borde);
      padding: 10px 8px;
      text-align: center;
      font-size: 1rem;
    }
    th {
      background: var(--azul-secundario);
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    tr:nth-child(even) td {
      background: #f7f9fc;
    }
    canvas {
      display: block;
      margin: 0 auto 1.5rem auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(26,35,126,0.04);
      max-width: 100%;
      height: 320px !important;
    }
    @media (max-width: 900px) {
      .container { padding: 1rem 0.2rem; }
      .card { padding: 1rem 0.5rem 1.5rem 0.5rem; }
      .filtros { flex-direction: column; align-items: flex-start; gap: 0.7rem; }
    }
  </style>
</head>
<body>
  <h1>Dashboard de Tickets</h1>
  <div class="container">
    <div class="filtros">
      <label>Desde: <input type="date" id="filtroDesde"></label>
      <label>Hasta: <input type="date" id="filtroHasta"></label>
      <label>Departamento:
        <select id="filtroDepartamento">
          <option value="">Todos</option>
          <option value="Mantenimiento">Mantenimiento</option>
          <option value="Sistemas">Sistemas</option>
        </select>
      </label>
      <label>Estado:
        <select id="filtroEstado">
          <option value="">Todos</option>
          <option value="Pendiente">Pendiente</option>
          <option value="En Proceso">En Proceso</option>
          <option value="Resuelto">Resuelto</option>
        </select>
      </label>
      <label>Asignado a:
        <input type="text" id="filtroAsignado" placeholder="Usuario asignado">
      </label>
      <button onclick="actualizarDashboard()">Filtrar</button>
      <button onclick="descargarExcel()">Descargar Excel</button>
    </div>

    <div class="card">
      <h2>Tiempo medio de atención por usuario</h2>
      <table id="tiempoMedio">
        <thead>
          <tr><th>Usuario</th><th>Tiempo Medio (minutos)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Solicitantes que más tickets crean</h2>
      <canvas id="solicitantesChart" width="400" height="200"></canvas>
    </div>

    <div class="card">
      <h2>Tickets por Departamento</h2>
      <canvas id="departamentoChart" width="400" height="200"></canvas>
    </div>

    <div class="card">
      <h2>Tiempo medio y total por usuario asignado</h2>
      <canvas id="tiempoAsignadoChart" width="400" height="200"></canvas>
    </div>

    <div class="card">
      <h2>Tickets por Estado</h2>
      <canvas id="estadoChart" width="400" height="200"></canvas>
    </div>

    <div class="card">
      <h2>Tickets hechos por usuario asignado</h2>
      <canvas id="asignadoChart" width="400" height="200"></canvas>
    </div>
  </div>

  <script>
    // Variables globales para los charts (para poder destruirlos y recrearlos)
    let solicitantesChart, departamentoChart, tiempoAsignadoChart, estadoChart, asignadoChart;
    let datosTiempoMedio = [];
    let datosSolicitantes = [];
    let datosPorDepartamento = [];
    let datosTiempoAsignado = [];
    let datosPorEstado = [];
    let datosPorAsignado = [];

  function getFiltros() {
    const desde = document.getElementById('filtroDesde').value;
    const hasta = document.getElementById('filtroHasta').value;
    const departamento = document.getElementById('filtroDepartamento').value;
    const estado = document.getElementById('filtroEstado').value;
    const asignado = document.getElementById('filtroAsignado').value;
    return { desde, hasta, departamento, estado, asignado };
  }

  function armarQueryString(filtros) {
    const params = [];
    if (filtros.desde) params.push(`desde=${filtros.desde}`);
    if (filtros.hasta) params.push(`hasta=${filtros.hasta}`);
    if (filtros.departamento) params.push(`departamento=${encodeURIComponent(filtros.departamento)}`);
    if (filtros.estado) params.push(`estado=${encodeURIComponent(filtros.estado)}`);
    if (filtros.asignado) params.push(`asignado=${encodeURIComponent(filtros.asignado)}`);
    return params.length ? '?' + params.join('&') : '';
  }

    function actualizarDashboard() {
      const filtros = getFiltros();
      const query = armarQueryString(filtros);

      // Tiempo medio de atención por usuario (tabla)
      fetch('/api/dashboard/tiempo-medio' + query)
        .then(res => res.json())
        .then(data => {
          datosTiempoMedio = data; // Guardar para Excel
          const tbody = document.querySelector('#tiempoMedio tbody');
          tbody.innerHTML = '';
          data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${row.usuario}</td><td>${row.tiempo_medio_minutos ?? '-'}</td>`;
            tbody.appendChild(tr);
          });
        });

      // Solicitantes que más tickets crean (gráfica)
      fetch('/api/dashboard/solicitantes-top' + query)
        .then(res => res.json())
        .then(data => {
          datosSolicitantes = data; // Guardar para Excel
          const labels = data.map(row => row.requester);
          const values = data.map(row => row.total);
          if (solicitantesChart) solicitantesChart.destroy();
          const ctx = document.getElementById('solicitantesChart').getContext('2d');
          solicitantesChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Tickets por solicitante',
                data: values,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { stepSize: 1 }
                }
              }
            }
          });
        });

      // Tickets por departamento (gráfica)
      fetch('/api/dashboard/tickets-por-departamento' + query)
        .then(res => res.json())
        .then(data => {
          datosPorDepartamento = data; // Guardar para Excel
          const labels = data.map(row => row.department);
          const values = data.map(row => row.total);
          if (departamentoChart) departamentoChart.destroy();
          departamentoChart = new Chart(document.getElementById('departamentoChart').getContext('2d'), {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [{
                label: 'Tickets por departamento',
                data: values,
                backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0'],
              }]
            }
          });
        });

      // Tiempo medio y total por usuario asignado (gráfica)
      fetch('/api/dashboard/tiempo-asignado' + query)
        .then(res => res.json())
        .then(data => {
          datosTiempoAsignado = data; // Guardar para Excel
          const labels = data.map(row => row.asignado_a);
          const medios = data.map(row => row.tiempo_medio_minutos);
          const totales = data.map(row => row.tiempo_total_minutos);
          if (tiempoAsignadoChart) tiempoAsignadoChart.destroy();
          tiempoAsignadoChart = new Chart(document.getElementById('tiempoAsignadoChart').getContext('2d'), {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'Tiempo medio (min)',
                  data: medios,
                  backgroundColor: 'rgba(54, 162, 235, 0.5)'
                },
                {
                  label: 'Tiempo total (min)',
                  data: totales,
                  backgroundColor: 'rgba(255, 99, 132, 0.5)'
                }
              ]
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true } }
            }
          });
        });

      // Tickets por estado (gráfica)
      fetch('/api/dashboard/tickets-por-estado' + query)
        .then(res => res.json())
        .then(data => {
          datosPorEstado = data; // Guardar para Excel
          const labels = data.map(row => row.status);
          const values = data.map(row => row.total);
          if (estadoChart) estadoChart.destroy();
          estadoChart = new Chart(document.getElementById('estadoChart').getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                label: 'Tickets por estado',
                data: values,
                backgroundColor: ['#FFCE56', '#36A2EB', '#FF6384'],
              }]
            }
          });
        });

      // Tickets hechos por usuario asignado (gráfica)
      fetch('/api/dashboard/tickets-por-asignado' + query)
        .then(res => res.json())
        .then(data => {
          datosPorAsignado = data; // Guardar para Excel
          const labels = data.map(row => row.asignado_a);
          const values = data.map(row => row.total);
          if (asignadoChart) asignadoChart.destroy();
          asignadoChart = new Chart(document.getElementById('asignadoChart').getContext('2d'), {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Tickets resueltos',
                data: values,
                backgroundColor: 'rgba(75, 192, 192, 0.5)'
              }]
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true, stepSize: 1 } }
            }
          });
        });
    }

    // Exportar todos los datos a Excel
    function descargarExcel() {
      const wb = XLSX.utils.book_new();

      if (datosTiempoMedio.length)
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(datosTiempoMedio), "Tiempo Medio");
      if (datosSolicitantes.length)
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(datosSolicitantes), "Solicitantes Top");
      if (datosPorDepartamento.length)
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(datosPorDepartamento), "Por Departamento");
      if (datosTiempoAsignado.length)
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(datosTiempoAsignado), "Tiempo Asignado");
      if (datosPorEstado.length)
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(datosPorEstado), "Por Estado");
      if (datosPorAsignado.length)
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(datosPorAsignado), "Por Asignado");

      XLSX.writeFile(wb, "dashboard_tickets.xlsx");
    }

    // Cargar dashboard al inicio
    window.onload = actualizarDashboard;
  </script>
</body>
</html>